<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Palpair Admin - Live Chats</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        background: #0b1220;
        color: #e5e7eb;
      }
      .topbar {
        padding: 12px 16px;
        border-bottom: 1px solid #1f2937;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .status { font-size: 0.9rem; opacity: 0.9; }
      .notify-btn {
        margin-left: 10px;
        background: #2563eb;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .notify-btn:disabled { opacity: 0.6; cursor: default; }
      .wrap {
        display: grid;
        grid-template-columns: 360px 1fr;
        min-height: calc(100vh - 52px);
      }
      .list {
        border-right: 1px solid #1f2937;
        overflow-y: auto;
      }
      .panel-title {
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.8;
        padding: 10px 12px;
        border-bottom: 1px solid #1f2937;
        background: #0f172a;
      }
      .online-users {
        max-height: 34vh;
        overflow-y: auto;
        border-bottom: 1px solid #1f2937;
      }
      .online-item {
        padding: 10px 12px;
        border-bottom: 1px solid #1f2937;
        font-size: 0.86rem;
      }
      .online-item:last-child { border-bottom: 0; }
      .online-name { font-weight: 700; }
      .online-meta { opacity: 0.8; margin-top: 2px; }
      .item {
        padding: 12px;
        border-bottom: 1px solid #1f2937;
        cursor: pointer;
      }
      .item:hover { background: #111827; }
      .item.active { background: #1d4ed8; }
      .item-title { font-weight: 700; margin-bottom: 4px; }
      .item-meta { font-size: 0.82rem; opacity: 0.85; }
      .detail {
        padding: 16px;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 12px;
      }
      .cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .card {
        background: #111827;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 12px;
      }
      .card h3 { margin: 0 0 8px; font-size: 0.95rem; }
      .meta-row { font-size: 0.88rem; margin-bottom: 4px; }
      .chat-box {
        background: #0f172a;
        border: 1px solid #1f2937;
        border-radius: 10px;
        overflow-y: auto;
        padding: 12px;
        min-height: 240px;
      }
      .msg { margin-bottom: 10px; font-size: 0.92rem; }
      .msg-time { opacity: 0.7; font-size: 0.8rem; margin-right: 6px; }
      .msg-from { font-weight: 700; margin-right: 6px; }
      .empty { opacity: 0.7; padding: 12px; }
      @media (max-width: 900px) {
        .wrap { grid-template-columns: 1fr; }
        .list { max-height: 38vh; border-right: 0; border-bottom: 1px solid #1f2937; }
        .cards { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <strong>Palpair Admin - Live Chats</strong>
      <div>
        <span id="connStatus" class="status">Connecting...</span>
        <button id="enableNotifyBtn" class="notify-btn">Enable Notifications</button>
      </div>
    </div>
    <div class="wrap">
      <div class="list">
        <div class="panel-title">Online Users</div>
        <div id="onlineUsers" class="online-users"></div>
        <div class="panel-title">Chats</div>
        <div id="chatList"></div>
      </div>
      <div class="detail">
        <div id="chatMeta" class="cards">
          <div class="card"><h3>Chat Info</h3><div class="empty">Select a chat from the left.</div></div>
          <div class="card"><h3>Participants</h3><div class="empty">No chat selected.</div></div>
        </div>
        <div id="chatMessages" class="chat-box">
          <div class="empty">No conversation selected.</div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const adminKey = params.get('key') || '';
      const socket = io('/admin', { auth: { key: adminKey } });

      const chatListEl = document.getElementById('chatList');
      const onlineUsersEl = document.getElementById('onlineUsers');
      const chatMetaEl = document.getElementById('chatMeta');
      const chatMessagesEl = document.getElementById('chatMessages');
      const connStatusEl = document.getElementById('connStatus');
      const enableNotifyBtn = document.getElementById('enableNotifyBtn');

      const chatSummaries = new Map();
      let onlineUsers = [];
      let previousOnlineUserIds = new Set();
      let onlineUsersInitialized = false;
      let selectedChatId = null;

      function updateNotifyButtonState() {
        if (!('Notification' in window)) {
          enableNotifyBtn.textContent = 'Notifications Unsupported';
          enableNotifyBtn.disabled = true;
          return;
        }
        if (Notification.permission === 'granted') {
          enableNotifyBtn.textContent = 'Notifications Enabled';
          enableNotifyBtn.disabled = true;
          return;
        }
        if (Notification.permission === 'denied') {
          enableNotifyBtn.textContent = 'Notifications Blocked';
          enableNotifyBtn.disabled = true;
          return;
        }
        enableNotifyBtn.textContent = 'Enable Notifications';
        enableNotifyBtn.disabled = false;
      }

      function notifyUserJoined(newUsers) {
        if (!newUsers.length) return;
        const count = newUsers.length;
        const title = count === 1 ? 'New user joined' : `${count} new users joined`;
        const body = newUsers.map((u) => u.name || u.shortId).join(', ');

        if ('Notification' in window && Notification.permission === 'granted') {
          try {
            new Notification(title, { body: body || 'A new user connected to Palpair.' });
          } catch (e) {
            // ignore notification errors
          }
        }

        if (navigator.vibrate) {
          navigator.vibrate([120, 80, 120]);
        }
      }

      function fmtTime(ts) {
        if (!ts) return '-';
        const date = new Date(ts);
        return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      }

      function renderList() {
        const chats = Array.from(chatSummaries.values()).sort((a, b) => {
          const aTime = new Date(a.startedAt || 0).getTime();
          const bTime = new Date(b.startedAt || 0).getTime();
          if (a.status === 'active' && b.status !== 'active') return -1;
          if (a.status !== 'active' && b.status === 'active') return 1;
          return bTime - aTime;
        });

        if (!chats.length) {
          chatListEl.innerHTML = '<div class="empty">No chats yet.</div>';
          return;
        }

        chatListEl.innerHTML = chats.map((chat) => {
          const names = (chat.participants || []).map(p => p.name || p.socketId?.slice(0, 8)).join(' ↔ ');
          const activeClass = chat.id === selectedChatId ? 'active' : '';
          return `
            <div class="item ${activeClass}" data-chat-id="${chat.id}">
              <div class="item-title">${names}</div>
              <div class="item-meta">${fmtTime(chat.startedAt)} • ${chat.status} • ${chat.messageCount} messages</div>
            </div>
          `;
        }).join('');

        document.querySelectorAll('.item').forEach((item) => {
          item.addEventListener('click', () => {
            const chatId = item.getAttribute('data-chat-id');
            selectedChatId = chatId;
            renderList();
            socket.emit('admin-get-chat', { chatId });
          });
        });
      }

      function renderOnlineUsers() {
        if (!onlineUsers.length) {
          onlineUsersEl.innerHTML = '<div class="empty">No users online.</div>';
          return;
        }

        onlineUsersEl.innerHTML = onlineUsers.map((user) => {
          const label = user.name || user.shortId;
          const role = user.isBot ? 'Bot' : 'User';
          const state = user.paired ? 'paired' : (user.searching ? 'searching' : 'idle');
          const details = [user.age ? `Age ${user.age}` : null, user.gender, user.country].filter(Boolean).join(' • ');
          return `
            <div class="online-item">
              <div class="online-name">${label} (${role})</div>
              <div class="online-meta">${state}${details ? ` • ${details}` : ''}</div>
            </div>
          `;
        }).join('');
      }

      function processOnlineUsers(users) {
        onlineUsers = users || [];
        renderOnlineUsers();

        const currentRealUsers = onlineUsers.filter((u) => !u.isBot);
        const currentIds = new Set(currentRealUsers.map((u) => u.socketId));

        if (onlineUsersInitialized) {
          const joined = currentRealUsers.filter((u) => !previousOnlineUserIds.has(u.socketId));
          notifyUserJoined(joined);
        }

        previousOnlineUserIds = currentIds;
        onlineUsersInitialized = true;
      }

      function renderDetail(chat) {
        if (!chat) return;

        const p1Id = chat.participants?.[0];
        const p2Id = chat.participants?.[1];
        const p1 = chat.participantDetails?.[p1Id] || {};
        const p2 = chat.participantDetails?.[p2Id] || {};

        chatMetaEl.innerHTML = `
          <div class="card">
            <h3>Chat Info</h3>
            <div class="meta-row"><strong>ID:</strong> ${chat.id}</div>
            <div class="meta-row"><strong>Started:</strong> ${fmtTime(chat.startedAt)}</div>
            <div class="meta-row"><strong>Ended:</strong> ${chat.endedAt ? fmtTime(chat.endedAt) : 'Active'}</div>
            <div class="meta-row"><strong>Status:</strong> ${chat.status}</div>
            <div class="meta-row"><strong>Messages:</strong> ${chat.messages?.length || 0}</div>
          </div>
          <div class="card">
            <h3>Participants</h3>
            <div class="meta-row"><strong>A:</strong> ${(p1.profile?.name || p1Id || '').toString()} ${p1.isBot ? '(Bot)' : ''}</div>
            <div class="meta-row">Age: ${p1.profile?.age ?? '-'} | Gender: ${p1.profile?.gender ?? '-'} | Country: ${p1.profile?.country ?? '-'}</div>
            <div class="meta-row"><strong>B:</strong> ${(p2.profile?.name || p2Id || '').toString()} ${p2.isBot ? '(Bot)' : ''}</div>
            <div class="meta-row">Age: ${p2.profile?.age ?? '-'} | Gender: ${p2.profile?.gender ?? '-'} | Country: ${p2.profile?.country ?? '-'}</div>
          </div>
        `;

        const messages = chat.messages || [];
        if (!messages.length) {
          chatMessagesEl.innerHTML = '<div class="empty">No messages in this chat.</div>';
          return;
        }

        const namesBySocket = {};
        for (const socketId of chat.participants || []) {
          const details = chat.participantDetails?.[socketId];
          namesBySocket[socketId] = details?.profile?.name || socketId.slice(0, 8);
        }

        chatMessagesEl.innerHTML = messages.map((msg) => `
          <div class="msg">
            <span class="msg-time">[${fmtTime(msg.timestamp)}]</span>
            <span class="msg-from">${namesBySocket[msg.fromSocketId] || msg.fromSocketId?.slice(0,8)}:</span>
            <span>${(msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
          </div>
        `).join('');
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }

      socket.on('connect', () => {
        connStatusEl.textContent = 'Connected';
      });

      socket.on('disconnect', () => {
        connStatusEl.textContent = 'Disconnected';
      });

      socket.on('connect_error', (err) => {
        connStatusEl.textContent = `Auth/Error: ${err.message}`;
      });

      socket.on('admin-init', ({ activeChats = [], completedChats = [], onlineUsers: users = [] }) => {
        chatSummaries.clear();
        [...activeChats, ...completedChats].forEach((chat) => chatSummaries.set(chat.id, chat));
        processOnlineUsers(users);
        renderList();
      });

      socket.on('admin-online-users', ({ onlineUsers: users = [] }) => {
        processOnlineUsers(users);
      });

      async function refreshOnlineUsersFallback() {
        try {
          const response = await fetch('/api/admin-online-users', { cache: 'no-store' });
          if (!response.ok) return;
          const payload = await response.json();
          processOnlineUsers(payload.onlineUsers || []);
        } catch (e) {
          // ignore fallback polling errors
        }
      }

      setInterval(refreshOnlineUsersFallback, 3000);
      refreshOnlineUsersFallback();

      enableNotifyBtn.addEventListener('click', async () => {
        if (!('Notification' in window)) return;
        try {
          await Notification.requestPermission();
        } catch (e) {
          // ignore
        }
        updateNotifyButtonState();
      });

      updateNotifyButtonState();

      socket.on('chat-created', ({ summary }) => {
        if (!summary) return;
        chatSummaries.set(summary.id, summary);
        renderList();
      });

      socket.on('chat-updated', ({ summary, chatId }) => {
        if (summary) chatSummaries.set(summary.id, summary);
        renderList();
        if (selectedChatId && chatId === selectedChatId) {
          socket.emit('admin-get-chat', { chatId: selectedChatId });
        }
      });

      socket.on('chat-ended', ({ summary, chatId }) => {
        if (summary) chatSummaries.set(summary.id, summary);
        renderList();
        if (selectedChatId && chatId === selectedChatId) {
          socket.emit('admin-get-chat', { chatId: selectedChatId });
        }
      });

      socket.on('admin-chat-detail', ({ chat }) => {
        if (!chat) return;
        renderDetail(chat);
      });
    </script>
  </body>
</html>
